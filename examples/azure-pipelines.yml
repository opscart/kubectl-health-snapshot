trigger:
  branches:
    include:
    - main

schedules:
- cron: "0 8 * * *"
  displayName: Daily cluster health check
  branches:
    include:
    - main
  always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  CLUSTER_NAME: 'production'

steps:
- task: Kubernetes@1
  displayName: 'Configure kubectl'
  inputs:
    connectionType: 'Kubernetes Service Connection'
    kubernetesServiceEndpoint: 'prod-aks-connection'
    command: 'login'

- script: |
    sudo apt-get update
    sudo apt-get install -y jq
  displayName: 'Install dependencies'

- script: |
    cd scripts
    chmod +x k8s-cluster-discovery.sh
    ./k8s-cluster-discovery.sh $(CLUSTER_NAME) json
    ./k8s-cluster-discovery.sh $(CLUSTER_NAME) html
  displayName: 'Generate cluster health reports'

- script: |
    cd scripts/cluster-reports
    LATEST_JSON=$(ls -t $(CLUSTER_NAME)_*.json | head -1)
    PROBLEMS=$(jq '[.pod_health[].problems[]] | length' "$LATEST_JSON")
    echo "##vso[task.setvariable variable=problemCount]$PROBLEMS"
    
    if [ "$PROBLEMS" -gt 5 ]; then
      echo "##vso[task.logissue type=warning]Cluster has $PROBLEMS problematic pods"
      echo "##vso[task.complete result=Failed;]"
    else
      echo "Cluster healthy: $PROBLEMS issues found"
    fi
  displayName: 'Check cluster health'
  continueOnError: true

- task: PublishBuildArtifacts@1
  displayName: 'Publish HTML Report'
  condition: always()
  inputs:
    PathtoPublish: 'scripts/cluster-reports'
    ArtifactName: 'cluster-health-reports'
    publishLocation: 'Container'

- task: PowerShell@2
  displayName: 'Send Teams Notification'
  condition: failed()
  inputs:
    targetType: 'inline'
    script: |
      $body = @{
        text = "Cluster health check failed for $(CLUSTER_NAME). Check pipeline artifacts for details."
      } | ConvertTo-Json
      
      Invoke-RestMethod -Uri "$(TEAMS_WEBHOOK_URL)" -Method Post -Body $body -ContentType 'application/json'